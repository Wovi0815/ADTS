<!DOCTYPE html>
<html lang="en" xmlns="http://www.thymeleaf.org">
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- Font Awesome -->
	 	<link rel="stylesheet" th:href="@{/plugins/fontawesome-free/css/all.min.css}"> 
		<!-- Ionicons -->
		<link rel="stylesheet" th:href="@{/dist/css/ionicons.css}">
		<!-- Tempusdominus Bbootstrap 4 -->
		<link rel="stylesheet" th:href="@{/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css}">
		<!-- iCheck -->
		<link rel="stylesheet" th:href="@{/plugins/icheck-bootstrap/icheck-bootstrap.min.css}">
		<!-- DataTables -->
  		<link rel="stylesheet" th:href="@{/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css}">
  		<link rel="stylesheet" th:href="@{/plugins/datatables-responsive/css/responsive.bootstrap4.min.css}">
		<!-- Theme style -->
		<link rel="stylesheet" th:href="@{/dist/css/adminlte.min.css}">
		<!-- overlayScrollbars -->
		<link rel="stylesheet" th:href="@{/plugins/overlayScrollbars/css/OverlayScrollbars.min.css}">
		<!-- toastr -->
		<link rel="stylesheet" th:href="@{/plugins/toastr/toastr.min.css}">

		<title>类页面</title>
		<style type="text/css">
		input::-webkit-input-placeholder {
			/* WebKit browsers */
			font-size: 10px;
		}

		input:-moz-placeholder {
			/* Mozilla Firefox 4 to 18 */
			font-size: 10px;
		}

		input::-moz-placeholder {
			/* Mozilla Firefox 19+ */
			font-size: 10px;
		}

		input:-ms-input-placeholder {
			/* Internet Explorer 10+ */
			font-size: 10px;
		}
		
	</style>
		
	</head>
	<body>




<!-- 详情模态框 -->
	<div class="modal fade" id="modal-detail">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title" id="modalTitle"></h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              	<!-- 模态框内容 -->
			<div class="form-group" id="descArea">
			
			</div>
            </div>
          </div>
        </div>
      </div>
      <!-- 新增编辑模态框 -->
	<div class="modal fade" id="modal-default">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title" id="modalTitle"></h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              
              	<!-- 模态框内容 -->
			<div class="form-group" >
			 <label for="iclsId">类标识</label>
			 <input class="form-control" placeholder="类标识" id="iclsId" >
			</div>
			
			<div class="form-group">
			 <label for="iclsName">类名称</label>
			 <input class="form-control" placeholder="类名称" id="iclsName" >
			</div>
			<div class="form-group">
			 <label for="iclsDesc">类描述</label>
			 <input class="form-control" placeholder="类描述" id="iclsDesc">
			</div>
			<div class="form-group">
			 <label for="iclsFather">父类</label>
			 <select class="form-control select2bs4"    id="iclsFather">
			 
		     </select>
			</div>
			<div class="form-group">
			 <label for="iclsMidware">所属中间件</label>
			 <input class="form-control" placeholder="所属中间件" id="iclsMidware" readonly="readonly">
			</div>

            </div>
            <div class="modal-footer justify-content-between">
              <button id='closeModal' type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
              <button id='saveModal' type="button"  class="btn btn-primary" onclick="save();">保存</button>
            </div>
            
          </div>
        </div>
      </div>

	
		<!-- 表格相关 -->   
            <div class="card-body">  
           
      <button id='addBtn'type='button' style="margin-right:2% ;width: 5%;float: right;"class='btn btn-block btn-outline-info btn-sm' data-toggle="modal" data-target="#modal-default" onclick="addClick();">新增类</button> 
        
        <!-- 下拉搜索框开始 -->   
 		      <select class="form-control select2bs4"   style="margin-right:5%;width:15%;float:right;" id="selectClass">
				
		      </select>

        <!-- 下拉搜索框结束 -->     
        
       
              <table id="example1" class="table table-bordered table-striped">
                <thead>
                <tr>
                  <th>类标识</th>
                  <th>类名称</th>
                  
                  <th>父类</th>
                  <th>操作</th>
                </tr>
                </thead>
                <tbody >
                
                </tbody>
              </table>
         </div>

	<script th:src="@{/plugins/jquery/jquery.js}" ></script>
	<script type="module"th:src="@{/plugins/popper/esm/popper.js}"></script>
	<script type="module"th:src="@{/plugins/popper/popper.js}"></script>
	<script th:src="@{/plugins/popper/umd/popper.js}"></script>
	<script type="module"th:src="@{/plugins/bootstrap/js/bootstrap.min.js}"></script>
	<!-- jQuery -->
	<script th:src="@{/plugins/jquery/jquery.min.js}"></script>
	<!-- jQuery UI 1.11.4 -->
	<script th:src="@{/plugins/jquery-ui/jquery-ui.min.js}"></script>
	<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
	 <script>
	  $.widget.bridge('uibutton', $.ui.button)
	</script> 
	<!-- Bootstrap 4 -->
	<script th:src="@{/plugins/bootstrap4-duallistbox/jquery.bootstrap-duallistbox.min.js}"></script>
	<script th:src="@{/plugins/bootstrap-switch/js/bootstrap-switch.min.js}"></script>
	<script th:src="@{/plugins/bootstrap/js/bootstrap.bundle.min.js}"></script>
	<!-- DataTables -->
	<script th:src="@{/plugins/datatables/jquery.dataTables.min.js}"></script>
	<script th:src="@{/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js}"></script>
	<script th:src="@{/plugins/datatables-responsive/js/dataTables.responsive.min.js}"></script>
	<script th:src="@{/plugins/datatables-responsive/js/responsive.bootstrap4.min.js}"></script>
	
	<!-- ChartJS -->
	<script th:src="@{/plugins/chart.js/Chart.min.js}"></script>
	<!-- Sparkline -->
	<script th:src="@{/plugins/sparklines/sparkline.js}"></script>
	
	<!-- jQuery Knob Chart -->
	<script th:src="@{/plugins/jquery-knob/jquery.knob.min.js}"></script>
	<!-- overlayScrollbars -->
	<script th:src="@{/plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js}"></script>
	<!-- AdminLTE App -->
	<script th:src="@{/dist/js/adminlte.js}"></script>
	<!-- toastr -->
	<script th:src="@{/plugins/toastr/toastr.min.js}"></script>
	 	
	<!-- page script -->
<script type="text/javascript">

function GetRequest() {
var url = location.search; //获取url中"?"符后的字串
var theRequest = new Object();
 if (url.indexOf("?") != -1) {
       var str = url.substr(1);
       strs = str.split("&");
       for (var i = 0; i < strs.length; i++) {
           theRequest[strs[i].split("=")[0]] = decodeURIComponent(strs[i].split("=")[1]);
       }
   }
   return theRequest;
}

//------全局变量-------
var a=GetRequest();//中间件菜单传值
var midwareId=a['midwareId'];
var clickKey;
//------全局变量-------


function qryMidCls(){//查中间件下属类
	$("#example1 tbody" ).empty();
	$.ajax({
		url:"/QueryMidwareClass",
		type:"POST",
		async:true,
		data:{"midwareId":midwareId},
		success:function(result){
			var body="";
			for(var i=0;i<result.length;i++){
				body = "<tr>";
		        body    += "<td id='tclsId'>" + result[i].c_id + "</td>";
		        body    += "<td id='tclsName'>" + result[i].c_name + "</td>";
		        //body    += "<td id='tclsDesc'>" + result[i].c_desc + "</td>";  
		        body    += "<td id='tclsFather'>" + result[i].c_father + "</td>";
		        body    += "<td>"+
		        "<button id='detailBtn' type='button' style='margin-left: 4%;width: 20%;float: left;margin-top: 0px;'class='btn btn-block btn-outline-success btn-sm' data-toggle='modal' data-target='#modal-detail'onclick='detailClick(this);'>类详情</button> "+
		        "<button id='editBtn' type='button' style='margin-left: 4%;width: 20%;float: left;margin-top: 0px;'class='btn btn-block btn-outline-primary btn-sm' data-toggle='modal' data-target='#modal-default'onclick='editClick(this);'>修改</button> "+
		        "<button id='deleteBtn' type='button' style='margin-left: 4%; width: 20%;float: left; margin-top: 0px;'class='btn btn-block btn-outline-danger btn-sm'   onclick='deleteClick(this);'>删除</button> "+
		        "<button id='infBtn'type='button' style='margin-left: 4%;width: 20%;float: left; margin-top: 0px;'class='btn btn-block btn-outline-warning btn-sm' onclick='toInterface(this);'>下属接口</button> "+
		        "</td>";
		        body    += "</tr>";
			    $("#example1 tbody" ).append(body); 
			}
			$("#example1").DataTable({
			
				 "autoWidth": false,
			      "paging": true,
			      "lengthChange": true,
			      "searching": false,
			      "ordering": true,
			      "info": true,
			    });

		},
		error:function(result){
			toastr.warning('未知错误,请联系管理员!');
		}
	});

}
//查询中间件的当前类页面的所有父类
function qryMidClsFather(){
	$("#selectClass" ).empty();
	$.ajax({
		url:"/QryMidClsFather",
		type:"POST",
		async:true,
		data:{"midwareId":midwareId},
		success:function(result){
			var obody="<option>筛选条件/父类</option>";
			for(var i=0;i<result.length;i++){
	        	obody	+= "<option id='opitem'>"+result[i].c_father +"</option>";
				}
			$("#selectClass" ).append(obody);
		},	
		error:function(result){
			toastr.warning('未知错误,请联系管理员!');
		}
	});
}


//根据下拉框重新刷新表格
$("#selectClass").change(function(){
	var cfather =$("#selectClass").val();
	if(cfather=="筛选条件/父类"){
		cfather=null;	
	}
		 var oldTable = $('#example1').dataTable();
		    oldTable.fnClearTable(); 
		    oldTable.fnDestroy();
		$.ajax({
			url:"/QryMidClsByFather",
			type:"POST",
			async:true,
			data:{
				"cfather":cfather,
			"midwareId":midwareId
			},
			success:function(result){
				var body ="";
				for(var i=0;i<result.length;i++){
					body = "<tr>";
			        body    += "<td id='tclsId'>" + result[i].c_id + "</td>";
			        body    += "<td id='tclsName'>" + result[i].c_name + "</td>";
			       // body    += "<td id='tclsDesc'>" + result[i].c_desc + "</td>";  
			        body    += "<td id='tclsFather'>" + result[i].c_father + "</td>";
			        body    += "<td>"+
			        "<button id='detailBtn' type='button' style='margin-left: 4%;width: 20%;float: left;margin-top: 0px;'class='btn btn-block btn-outline-success btn-sm' data-toggle='modal' data-target='#modal-detail'onclick='detailClick(this);'>类详情</button> "+
			        "<button id='editBtn' type='button' style='margin-left: 4%;width: 20%;float: left;margin-top: 0px;'class='btn btn-block btn-outline-primary btn-sm' data-toggle='modal' data-target='#modal-default'onclick='editClick(this);'>修改</button> "+
			        "<button id='deleteBtn' type='button' style='margin-left: 4%; width: 20%;float: left; margin-top: 0px;'class='btn btn-block btn-outline-danger btn-sm'   onclick='deleteClick(this);'>删除</button> "+
			        "<button id='infBtn'type='button' style='margin-left: 4%;width: 20%;float: left; margin-top: 0px;'class='btn btn-block btn-outline-warning btn-sm' onclick='toInterface(this);''>下属接口</button> "+
			        "</td>";
			        body    += "</tr>";  
			        $("#example1 tbody" ).append(body); 
				}
				$("#example1").DataTable({
					
				      "autoWidth": false,
				      "paging": true,
				      "lengthChange": true,
				      "searching": false,
				      "ordering": true,
				      "info": true,
				    });

			},
			error:function(result){
				toastr.warning('未知错误,请联系管理员!');
			}
		});

	
	
});
//查询所有类、供新增、编辑 使用 #####模态框：下拉#####
function qryClsBeFather(iclsFather){
	$("#iclsFather" ).empty();
	$.ajax({
		url:"/QryClsBeFather",
		type:"POST",
		async:true,
		data:{
			"midwareId":midwareId
		},
		success:function(result){
			for(var i=0;i<result.length;i++){
				var obody="";
				if(iclsFather == result[i].c_id){
					obody	+= "<option selected='selected'>"+result[i].c_id +"</option>";
				}else{
					obody	+= "<option>"+result[i].c_id +"</option>";
				}
	        	$("#iclsFather" ).append(obody);
			}
		},
		error:function(result){
			toastr.warning('未知错误,请联系管理员!');
		}
	});
}


//点击详情
function detailClick(e){
	$("#descArea").empty();
	 var cId=$(e).parent().parent().find("td").eq(0).text();		
	 $.ajax({
			url:"/QryMidClsByCId",
			type:"POST",
			async:true,
			data:{"cId":cId},
			success:function(result){
				var clsDesc = result.c_desc;
				var modifyUser = result.modify_user;
				var updateTime =result.update_time;
				var createTime = result.create_time;;
				var ibody="";
			   	ibody +="<div class='input-group'>";
				ibody += 	"<div class='input-group-prepend'>";
				ibody +=		 "<span class='input-group-text' >类描述</span>";
				ibody +=	 "</div>" ;
				ibody +=	 "<input type='text'   class='form-control' value='"+clsDesc+"'readonly='readonly'/>";
				ibody +="</div>";
				ibody +="<div class='input-group'>";
				ibody += 	"<div class='input-group-prepend'>";
				ibody +=		 "<span class='input-group-text' >维护人</span>";
				ibody +=	 "</div>" ;
				ibody +=	 "<input type='text'   class='form-control' value='"+modifyUser+"'readonly='readonly'/>";
				ibody +="</div>";
				ibody +="<div class='input-group'>";
				ibody += 	"<div class='input-group-prepend'>";
				ibody +=	 	"<span class='input-group-text' >创建时间 </span>";
				ibody +=   "</div>";
				ibody += 	"<input type='text'    class='form-control' value='"+createTime+"'readonly='readonly'/>";
				ibody +="<div class='input-group'>";
				ibody += 	"<div class='input-group-prepend'>";
				ibody +=	 	"<span class='input-group-text' >修改时间</span>";
				ibody +=   "</div>";
				ibody += 	"<input type='text'    class='form-control' value='"+updateTime+"'readonly='readonly'/>";
				ibody +="</div>";
				
				$("#descArea").append(ibody);
				
			},	
			error:function(result){
				toastr.warning('未知错误,请联系管理员!');
			}
		});	
	
}





//新增     ###模态框内容####
function addClick(){
	clickKey="add";
	qryClsBeFather();
	$("#iclsMidware").val(midwareId);
	$("#iclsId").val("");
	$("#iclsId").removeAttr("readonly");
	$("#iclsName").val("");
	$("#iclsDesc").val("");
    
}
//编辑     ###模态框内容####
function editClick(e){	
	clickKey="edit";
	    var cId=$(e).parent().parent().find("td").eq(0).text();
	    $.ajax({
			url:"/QryMidClsByCId",
			type:"POST",
			async:true,
			data:{
				"cId":cId
			},
			success:function(result){
				
				$("#iclsId").val(result.c_id);
				$("#iclsId").attr("readOnly","true");
				$("#iclsName").val(result.c_name);
				$("#iclsDesc").val(result.c_desc);
				var iclsFather =result.c_father;
				var iclsMidware =result.c_midware;
				$("#iclsMidware").val(result.c_midware);
				qryClsBeFather(iclsFather);
			},
			error:function(result){
				toastr.warning('未知错误,请联系管理员!');
			}
		}); 	 
}


function save(){
	var modalCId=$("#iclsId").val();
	var modalCName=$("#iclsName").val();
	var modalCDesc=$("#iclsDesc").val();
	var modalCFather=$("#iclsFather").val();
	var modalCMidware=$("#iclsMidware").val();
	if(modalCId==""||modalCName==""||modalCDesc==""||modalCFather==""||modalCMidware==""){
		toastr.info('类中必填项未填写充分!');
	}else{
		changeDataByKey(modalCId,modalCName,modalCDesc,modalCFather,modalCMidware);
	}
}

function changeDataByKey(modalCId,modalCName,modalCDesc,modalCFather,modalCMidware) {
	if(clickKey=="add"){
		//新增之前先进行查询类标识是否唯一   
		 $.ajax({
				url:"/QryMidClsByCId",
				type:"POST",
				async:true,
				data:{
					"cId":modalCId
				},
				success:function(result){
					if(result.c_id == modalCId){	
						toastr.error('类已存在!重复!');
					}else{
						insertData(modalCId,modalCName,modalCDesc,modalCFather,modalCMidware);//插入
					}
				},
				error:function(result){
					toastr.warning('未知错误,请联系管理员!');
				}
			}); 
					
	}else if(clickKey=="edit"){
		updateData(modalCId,modalCName,modalCDesc,modalCFather,modalCMidware);
	}

}	
//插入数据
function insertData(modalCId,modalCName,modalCDesc,modalCFather,modalCMidware){

		$.ajax({
			url:"/InsertCls",
			type:"POST",
			async:true,
			data:{
				"modalCId":modalCId,
				"modalCName":modalCName,
				"modalCDesc":modalCDesc,
				"modalCFather":modalCFather,
				"modalCMidware":modalCMidware
			},
			success:function(result){
				if(result==1){
					$("#modal-default").modal('hide'); 
					var oldTable = $('#example1').dataTable();
				    oldTable.fnClearTable(); 
				    oldTable.fnDestroy();
					qryMidCls();
					qryMidClsFather();
				}else{
					toastr.error('类新增失败!');
				}
				
			},
			error:function(result){
				toastr.warning('未知错误,请联系管理员!');
				
			}
		});
	
}
//更新数据
function updateData(modalCId,modalCName,modalCDesc,modalCFather,modalCMidware){
	$.ajax({
		url:"/UpdateCls",
		type:"POST",
		async:true,
		data:{
			"modalCId":modalCId,
			"modalCName":modalCName,
			"modalCDesc":modalCDesc,
			"modalCFather":modalCFather,
			"modalCMidware":modalCMidware
		},
		success:function(result){
			if(result==1){
				$("#modal-default").modal('hide'); 
				var oldTable = $('#example1').dataTable();
			    oldTable.fnClearTable(); 
			    oldTable.fnDestroy();
				qryMidCls();
				qryMidClsFather();
			}else{
				toastr.error('类修改失败!');
			}
			
		},
		error:function(result){
			toastr.warning('未知错误,请联系管理员!');
		}
	});

}	
// 删除
function deleteClick(e){
	var cId=$(e).parent().parent().find("td").eq(0).text();
	$.ajax({
		url:"/DeleteCls",
		type:"POST",
		async:true,
		data:{
			"cId":cId	
		},
		success:function(result){
			if(result==1){
				var oldTable = $('#example1').dataTable();
			    oldTable.fnClearTable(); 
			    oldTable.fnDestroy();
				qryMidCls();
				qryMidClsFather();
			}else{
				toastr.error('类删除失败!');
			}
			
		},
		error:function(result){
			toastr.warning('未知错误,请联系管理员!');
		}
	});
	
}

function toInterface(e){
	var cId=$(e).parent().parent().find("td").eq(0).text();
	window.parent.openInside.location.href="/interfaceMain?classId="+cId;	
}

function getUser(){
	$.ajax({
		url:"/getUser",
		type:"POST",
		async:true,
		success:function(result){
			if(result=="sessionNull"){
				toastr.options.onclick = function(){
					window.parent.openInside.location.href="/tologin";	
				}
				toastr.options.timeOut=60000;
				toastr.warning('连接断开!点击重新登录.');
				
			}
			var userName =result;
		},
		error:function(result){
			toastr.warning('未知错误,请联系管理员!');
		}
	});
	
}







</script>


<script type="text/javascript">
	toastr.options = {
			  "closeButton": true,
			  "debug": false,
			  "newestOnTop": true,
			  "progressBar": true,
			  "positionClass": "toast-top-full-width",
			  "preventDuplicates": false,
			  "onclick": null,
			  "showDuration": "300",
			  "hideDuration": "800",
			  "timeOut": "2500",
			  "extendedTimeOut": "1000",
			  "showEasing": "swing",
			  "hideEasing": "linear",
			  "showMethod": "fadeIn",
			  "hideMethod": "fadeOut"
			} 
	getUser();
	qryMidCls();
	qryMidClsFather();
	
</script>    
</body>
</html>
